#!/bin/sh
# postinst script for debdelta
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package

umask 0077

GPG_MASTER_PUB_KEYRING="/usr/share/keyrings/debian-debdelta-archive-keyring.gpg"
GPG_HOME="/etc/debdelta/gnupg"

sha1it () {
 (
    cd ${GPG_HOME}
    echo '#if this file is deleted or it does not match, then  ' > sha1_hashes.txt
    echo '# these files will not be removed when purging "debdelta"  ' >> sha1_hashes.txt
    sha1sum pubring.gpg  secring.gpg >> sha1_hashes.txt
    if test -f trustdb.gpg ; then sha1sum trustdb.gpg >> sha1_hashes.txt ; fi
 )
}

check1it () {
 (
  cd ${GPG_HOME}
  test -f sha1_hashes.txt && sha1sum -c --quiet sha1_hashes.txt
 )
}

case "$1" in
  configure|reconfigure)
    if test ! -r ${GPG_HOME} ; then
      echo "Debdelta: creating ${GPG_HOME}"
      mkdir ${GPG_HOME}
    fi
    if test ! -r ${GPG_HOME}/pubring.gpg -a \
            ! -r ${GPG_HOME}/secring.gpg   ; then
      echo "Debdelta: creating keyrings in ${GPG_HOME}"
      touch ${GPG_HOME}/secring.gpg  ${GPG_HOME}/pubring.gpg
      sha1it
    else
      echo "Debdelta: updating public keyring in ${GPG_HOME}"
    fi

    c=0 ;  if  check1it ; then   c=1 ;  fi
    gpg --no-tty --batch --no-options --no-auto-check-trustdb --homedir ${GPG_HOME} --import ${GPG_MASTER_PUB_KEYRING} || true
    if test $c = 1 ; then sha1it ; fi

    ;;

  abort-upgrade|abort-remove|abort-deconfigure)
    ;;

  *)
    echo "postinst called with unknown argument \`$1'" >&2
    exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
